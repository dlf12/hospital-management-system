# AI模板推荐功能升级说明

**升级日期**: 2025-11-02
**影响模块**: 智能推荐模板功能
**升级类型**: 从伪智能（关键词匹配）升级为真AI（大模型智能分析）

---

## 升级背景

### 升级前（伪智能）

**实现方式**：简单的关键词匹配算法
- 遍历所有模板，将用户症状与模板内容进行字符串匹配
- 计算匹配次数作为分数（`count()`函数）
- 按分数排序，返回最高分的模板

**问题**：
- ❌ 无法理解症状的语义和医学含义
- ❌ 只能匹配完全相同或包含的关键词
- ❌ 无法处理症状的同义词、相关描述
- ❌ 响应速度虽快，但推荐质量低

**示例**：
```
用户输入："头痛发烧"
- 只能匹配到包含"头痛"或"发烧"字眼的模板
- 无法匹配"发热头晕"这类同义症状
- 无法理解"感冒症状"与"头痛发烧"的关联
```

---

## 升级后（真AI）

### 实现方式

使用大语言模型进行智能分析和匹配：

1. **收集模板信息**：提取所有可用模板的ID、名称、症状、诊断等信息
2. **构建AI Prompt**：将用户症状和模板列表发送给大模型
3. **AI智能分析**：大模型理解症状语义，从模板中选择最相关的一个
4. **返回推荐结果**：包含选中的模板ID和AI的推荐理由

### 核心代码逻辑

**文件**: `backend/ai_service.py:110-209`

```python
def suggest_templates_by_symptom(symptom: str, templates: List[Dict]) -> List[Dict]:
    """基于症状使用AI进行智能模板推荐。"""

    # 1. 前置检查
    if not symptom or not templates:
        return []

    # 2. 获取AI客户端
    client = _get_llm_client()

    # 3. 构建模板摘要列表
    template_summaries = [...]

    # 4. 构建AI Prompt
    prompt = f"""
    你是一名经验丰富的临床医生助手。
    请根据患者症状，从以下可用的病历模板中选择最相关的一个。

    患者症状：{symptom}
    可用模板列表：[...]

    要求：
    1. 必须从上述模板中选择一个最相关的模板
    2. 即使症状不完全匹配，也要选择相关度最高的那个
    3. 返回JSON格式：{{"selected_template_id": ID, "reason": "理由"}}
    """

    # 5. 调用大模型
    response = client.chat.completions.create(
        model=LLM_MODEL,
        messages=[...],
        temperature=0.3,
        max_tokens=300,
    )

    # 6. 解析结果并返回
    return [{"id": ..., "name": ..., "reason": ...}]
```

### 优势特点

✅ **语义理解**：
- AI能理解症状的医学含义和关联性
- 可以匹配同义词、相关症状
- 理解症状组合的临床意义

✅ **智能推荐**：
- 即使症状不完全匹配，也能选择最相关的模板
- 基于医学知识而非简单字符串匹配
- 提供推荐理由，增强可解释性

✅ **容错降级**：
- AI调用失败时自动降级为关键词匹配
- 确保功能可用性

✅ **必选逻辑**：
- AI必须从现有模板中选择一个
- 如果没有模板，直接返回空（避免无效请求）

---

## 修改文件清单

### 后端修改

#### 1. `backend/ai_service.py`

**修改内容**：
- **第110-209行**：完全重写 `suggest_templates_by_symptom` 函数
- **第212-252行**：新增 `_fallback_keyword_match` 函数（降级方案）

**关键改动**：
```python
# 旧版（关键词匹配）
score = merged_text.count(symptom_lower)

# 新版（AI分析）
response = client.chat.completions.create(model=LLM_MODEL, ...)
```

---

### 前端修改

#### 1. `frontend/src/components/AiChatPanel.vue`

**修改位置1：第17-27行** - 更新欢迎消息
```vue
<!-- 旧版 -->
1️⃣ 智能推荐模板 - 基于症状匹配相似病历

<!-- 新版 -->
1️⃣ 智能推荐模板 - AI分析症状，从现有模板中智能匹配最相关的病历
```

**修改位置2：第106-110行** - 更新加载提示
```vue
<!-- 旧版 -->
🔍 正在分析症状，为您推荐合适的模板...

<!-- 新版 -->
🤖 AI正在深度分析症状，为您智能匹配最相关的模板...
```

**修改位置3：第131-147行** - 展示AI推荐理由
```vue
// 新增：如果有AI理由则展示
if (template.reason) {
  recommendMsg += `\n\n💡 推荐理由：${template.reason}`;
}
```

---

## 用户体验对比

### 升级前

```
[用户] 输入症状：持续咳嗽，有痰
[系统] 关键词匹配中...
[系统] 找到包含"咳嗽"的模板：感冒病历模板
[用户] （不知道为什么推荐这个）
```

### 升级后

```
[用户] 输入症状：持续咳嗽，有痰
[系统] 🤖 AI正在深度分析症状，为您智能匹配最相关的模板...
[系统] ✅ AI分析完成！为您推荐以下模板：

📋 【呼吸道感染病历模板】
【诊断】上呼吸道感染
【治疗方案】抗感染治疗，止咳化痰...

💡 推荐理由：患者症状"持续咳嗽，有痰"符合呼吸道感染的典型表现，该模板包含针对性的诊断和治疗方案。

是否应用此模板？
```

---

## 性能影响

### 响应时间

| 功能 | 升级前 | 升级后 |
|------|--------|--------|
| 智能推荐模板 | ~50ms（本地匹配） | ~2-5秒（AI分析） |
| 智能诊断建议 | ~2-5秒（AI生成） | ~2-5秒（无变化） |

**说明**：
- 智能推荐模板现在与智能诊断建议的响应时间相当
- 用户会感受到明显的"AI思考"过程，这反而增强了功能的可信度
- 加载动画和提示信息让用户知道AI正在工作

### API调用成本

- **升级前**：0次大模型调用
- **升级后**：每次推荐1次大模型调用（tokens消耗约200-500）

---

## 降级机制

为确保系统稳定性，实现了**三层降级策略**：

### 1. AI客户端获取失败
```python
try:
    client = _get_llm_client()
except RuntimeError:
    return _fallback_keyword_match(symptom, templates)
```

### 2. AI调用失败
```python
try:
    response = client.chat.completions.create(...)
except Exception:
    return _fallback_keyword_match(symptom, templates)
```

### 3. JSON解析失败
```python
try:
    result = json.loads(content)
except json.JSONDecodeError:
    return _fallback_keyword_match(symptom, templates)
```

**降级方案**：`_fallback_keyword_match` - 保留原关键词匹配逻辑，但只返回最相关的1个模板

---

## 测试建议

### 测试场景1：语义匹配测试

**目标**：验证AI能否理解同义症状

| 症状输入 | 模板内容 | 预期结果 |
|---------|---------|---------|
| "发烧头痛" | 包含"发热头晕" | ✅ 应该匹配 |
| "肚子疼" | 包含"腹痛" | ✅ 应该匹配 |
| "咳嗽有痰" | 包含"支气管炎" | ✅ 应该匹配 |

### 测试场景2：智能选择测试

**目标**：验证AI能从多个模板中选择最相关的

```
模板列表：
1. 感冒病历（症状：发热、咳嗽、流涕）
2. 肺炎病历（症状：高热、咳嗽、呼吸困难）
3. 胃炎病历（症状：胃痛、恶心）

输入症状："持续高烧，咳嗽严重，有点喘"
预期推荐：肺炎病历（因为有"高热"和"呼吸困难"的关联）
```

### 测试场景3：无模板场景

**输入**：任意症状
**模板列表**：空
**预期结果**：返回"暂未找到与症状匹配的模板"提示

### 测试场景4：降级机制测试

**操作**：临时关闭大模型服务或API密钥错误
**预期结果**：自动降级为关键词匹配，仍能返回结果

---

## 配置要求

确保后端配置文件正确：

**文件**: `backend/config.py`

```python
LLM_BASE_URL = "https://api.openai.com/v1"  # 或其他兼容接口
LLM_API_KEY = "sk-..."  # 有效的API密钥
LLM_MODEL = "gpt-3.5-turbo"  # 或其他模型
```

---

## 注意事项

### 1. API成本控制
- 每次推荐会消耗约200-500 tokens
- 建议监控API使用量
- 可根据需要调整 `temperature` 和 `max_tokens` 参数

### 2. 响应时间管理
- AI调用需要2-5秒，已添加加载动画
- 前端已显示"AI正在分析"提示
- 用户会明显感知到AI在工作

### 3. 错误处理
- 已实现完整的降级机制
- AI失败不会影响系统可用性
- 建议监控降级触发频率

### 4. 提示词优化
- 当前prompt已针对中文医疗场景优化
- 可根据实际效果调整prompt内容
- 建议定期review AI推荐质量

---

## 未来优化方向

### 1. 向量嵌入优化
使用embeddings预计算模板向量，实现快速语义搜索：
- 第一阶段：向量检索筛选top 5
- 第二阶段：AI精选top 1
- 优势：更快速度 + 更低成本

### 2. 推荐理由增强
让AI提供更详细的推荐理由：
- 症状匹配度分析
- 模板适用性说明
- 注意事项提醒

### 3. 多模板推荐
支持推荐多个模板供用户选择：
- AI排序top 3
- 用户可选择最合适的
- 增加灵活性

---

**文档版本**: v1.0
**更新日期**: 2025-11-02
**状态**: 已完成升级 ✅
