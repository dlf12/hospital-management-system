# 医院病历管理系统 - 更新说明

## 更新日期：2025-10-20

### 本次更新内容

#### 1. 数据库模型更新

在 `MedicalRecord` 模型中增加了两个新字段：
- **既往病史** (medical_history)：记录患者的既往病史信息
- **过敏史** (allergy_history)：记录患者的过敏史信息

#### 2. 后端API更新

更新了以下API接口以支持新增字段：
- `POST /api/patients/<patient_id>/records` - 创建病历，支持既往病史和过敏史
- `PUT /api/patients/<patient_id>/records/<record_id>` - 新增：更新病历接口
- `POST /api/patients/<patient_id>/records/<record_id>/save_as_template` - 保存为模板，包含新字段
- `POST /api/patients/<patient_id>/records/from_template/<tpl_id>` - 从模板创建病历，支持新字段

#### 3. 前端界面重构

**DepartmentView 组件完全重构：**

- ✅ 采用类似管理系统的表格布局（参考第三张图）
- ✅ 取消了原有的"病历信息"和"功能操作"侧边栏
- ✅ 病人列表占据主要空间，以表格形式展示
- ✅ 在表格顶部添加了搜索框和"新增"按钮
- ✅ 每行病人记录包含"编辑"、"病历编辑"、"删除"三个操作按钮

**病历编辑弹窗（核心功能）：**

- ✅ 左侧显示病人的历史病历列表
- ✅ 右侧为病历编辑表单，包含：
  - 诊断（必填）
  - 治疗方案（必填）
  - 既往病史（选填）
  - 过敏史（选填）
- ✅ 支持选择已有病历进行编辑
- ✅ 支持新增病历
- ✅ 顶部包含模板选择下拉框
- ✅ "导出为模板"按钮（仅在选中病历时可用）

**模板功能完善：**

- ✅ 修复了模板导入功能：选择模板后自动填充所有字段
- ✅ 模板管理界面支持新增的既往病史和过敏史字段
- ✅ 模板预览显示所有字段内容

#### 4. 样式优化

- ✅ 所有输入框使用浅色背景（白色）、深色字体（#2d3748）
- ✅ 移除了原有的深色输入区域
- ✅ 统一了整体界面风格，更加清晰美观
- ✅ 改进了表格样式，包括悬停效果和性别/角色徽章

### 数据库迁移步骤

**重要：在运行系统前必须执行数据库迁移！**

#### 方法一：使用 Flask-Migrate（推荐）

```bash
cd backend
python -m flask db upgrade
```

#### 方法二：手动执行SQL（如果方法一失败）

连接到 MySQL 数据库并执行以下SQL：

```sql
USE hospital_db;

ALTER TABLE medical_records 
ADD COLUMN medical_history TEXT NULL AFTER treatment_plan,
ADD COLUMN allergy_history TEXT NULL AFTER medical_history;
```

### 使用说明

#### 1. 进入科室

登录后选择相应科室（内科、外科、妇产科、儿科）

#### 2. 管理病人

- 点击"➕ 新增"按钮添加新病人
- 点击表格中的"编辑"按钮修改病人基本信息
- 点击"删除"按钮删除病人（会同时删除该病人的所有病历）

#### 3. 编辑病历

1. 点击"病历编辑"按钮打开病历管理窗口
2. 左侧显示该病人的所有历史病历
3. 点击"+ 新增病历"或选择已有病历进行编辑
4. 填写必填字段（诊断、治疗方案）和选填字段（既往病史、过敏史）
5. 可选：从下拉框选择模板快速填充内容
6. 点击"添加病历"或"更新病历"保存

#### 4. 使用模板

**导入模板：**
- 在病历编辑窗口，从"选择模板"下拉框中选择模板
- 模板内容会自动填充到对应字段

**导出为模板：**
- 选择一条已有病历
- 点击"📤 导出为模板"按钮
- 输入模板名称保存

**管理模板：**
- 点击顶部导航栏的"模板管理"按钮
- 可以创建、编辑、删除模板
- 模板支持共享功能

### 技术细节

#### 新增字段默认值

- `medical_history`: NULL（可选）
- `allergy_history`: NULL（可选）

#### API响应格式

病历对象现在包含以下字段：

```json
{
  "id": 1,
  "diagnosis": "诊断内容",
  "treatment_plan": "治疗方案",
  "medical_history": "既往病史",
  "allergy_history": "过敏史",
  "record_date": "2025-09-11 12:05:00",
  "patient_id": 123
}
```

### 注意事项

1. **数据库迁移是必需的**：如果不执行迁移，系统将无法正常工作
2. **向后兼容**：旧的病历数据会自动兼容，新字段为空值
3. **模板数据**：现有模板会自动适配，只是不包含新字段
4. **输入验证**：诊断和治疗方案仍然是必填项，既往病史和过敏史为可选

### 已知问题

暂无

### 下一步计划

- 增加病历打印功能
- 支持病历附件上传
- 增加病历搜索功能
- 支持批量导出病历

---

如有问题，请联系开发团队。

